<!DOCTYPE html>
<html>
<head>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.createjs.com/easeljs-0.7.0.min.js"></script>
    <script>
        function preloadimages(arr){
            var newimages=[], loadedimages=0
            var postaction=function(){}
            var arr=(typeof arr!="object")? [arr] : arr
            function imageloadpost(){
                loadedimages++
                if (loadedimages==arr.length){
                    postaction(newimages) //call postaction and pass in newimages array as parameter
                }
            }
            for (var i=0; i<arr.length; i++){
                newimages[i]=new Image()
                newimages[i].src=arr[i]
                newimages[i].onload=function(){
                    imageloadpost()
                }
                newimages[i].onerror=function(){
                    imageloadpost()
                }
            }
            return { //return blank object with done() method
                done:function(f){
                    postaction=f || postaction //remember user defined callback functions to be called when images load
                }
            }
        }

        jQuery(document).ready(function() {
            var stage = new createjs.Stage("demoCanvas");

            /*
            var circle = new createjs.Shape();
            circle.graphics.beginFill("red").drawCircle(0, 0, 50);
            circle.x = 100;
            circle.y = 100;
            stage.addChild(circle);
            */

            preloadimages(["/static/tiles/grassland.png", "/static/tiles/shrubland.png", "/static/tiles/shallow_water.png", "/static/tiles/deep_water.png", "/static/tiles/temperate_desert.png", ]).done(function() {
                var width = 500;
                var height = 300;

                var x = 168
                var y = 97;

                jQuery.get("/render_viewport", {size: width + "x" + height, top_left: 100 + "x" + 100}, function(data) {
                    data = data["tiles"];
                    var scale = .5;

                    var x_center = ((x/2) * scale);
                    var y_center = ((y/2) * scale);

                    for(var row in data) {
                        row = parseInt(row);
                        for(var column in data[row]) {
                            column = parseInt(column);
                            var bmp = new createjs.Bitmap("/static/tiles/" + data[row][column] + ".png");

                            var this_x = ((column - row) * x_center) + width/2;
                            var this_y = (row + column) * y_center;
                            bmp.x = this_x;
                            bmp.y = this_y;

                            bmp.scaleX = scale;
                            bmp.scaleY = scale;

                            bmp.regX = x/2;
                            bmp.regY = y/2;  // Delete this to set the control point to the top corner of each cell

                            stage.addChild(bmp);

                            var text = new createjs.Text("[" + row + "," + column + "]", "10px Arial", "black");
                            text.x = this_x;
                            text.y = this_y;
                            stage.addChild(text);

                            var circle = new createjs.Shape();
                            circle.graphics.beginFill("red").drawCircle(0, 0, 5);
                            circle.x = this_x;
                            circle.y = this_y;
                            stage.addChild(circle);
                        }
                    }

                    stage.update();
                });
            }, 1000);
        });
    </script>
</head>
<body>
    <canvas id="demoCanvas" width="500" height="300" style="border: 2px solid black;">
        alternate content
    </canvas>
</body>
</html>
